.. |nbsp| unicode:: 0xA0 
   :trim:

==========
VirtualBox
==========

VirtualBox の最新バージョンである 6.0 系を前提とします。
すでに VirtualBox 5 系で仮想化環境を使用されている方は、そのままで構いませんが、以下では 6.0 の画面で説明します。

VMWare など、他の仮想化環境でも問題はありません。ただし、講義では VirtualBox を前提としますので適宜読み替えてください。

インストール
============

`OracleVM VirtualBoxのインストール手順＜Windows向け＞ <https://sukkiri.jp/technologies/virtualizers/virtualbox/virtualbox-win_install.html>`_ に従ってインストールをお願いします。

注意点
------

* サイトから最新の VirtualBox を入手します。2019 年 3 月現在の最新バージョンは 6.0.4 となっています。

  * 2019 年 8 月 7 日のバージョンは 6.0.10 です。 6.0 の最新版を入手してください。
* **BIOS仮想化支援機能の確認** は特に嵌ります。

  * 昨年では Lenovo のノートパソコンで起動時に F12 を押せば BIOS の設定画面になるものの、一切画面では案内がでないという事例がありました。
  * Surface では BIOS 画面を出すには一度 Windows OS を立ち上げて、次回の起動時に BIOS 画面を出すという設定を行わないとなりません。しかもデフォルトでは仮想化支援機能（VT-x）は無効なので **必ず変更が必要となります。**

.. warning::
   事前に BIOS の設定を行うようお願いします。講義中の対応は難しいです。

VM イメージダウンロードとインポート
===================================

別途お知らせしている google drive の URL より、 Ubuntu-base.ova をダウンロードします。
ダウンロードしたらエクスプローラからダブルクリックで VirtualBox へのインポートを許可します（ :numref:`vmimport` 赤枠）。

.. figure:: ./images/vmimport.png
      :scale: 100
      :name: vmimport
      :align: center

      Ubuntu-base.ova のインポート
      
VM 仮想ネットワークカードの設定
===============================

VM からインターネットに接続するために VirtualBox 内で VM に与える仮想イーサネットアダプターの設定を行います。

教室内の DHCP から VM の IP アドレスを取得する方法もあるのですが（ブリッジモード）、教室を
離れると VM の IP アドレスが変わってしまうのと、ノートパソコンの外から VM への通信ができてしまいます。

そのため、VM のアップデートとか github など、ノートパソコンから外側への片方向通信をするための仮想イーサーネットアダプター（NAT）と、ノートパソコン内のみで双方向通信が行うことができる仮想イーサーネットアダプター（ホストオンリーアダプター）の二通りのネットワークを作製します。

ネットワーク管理画面を出す
--------------------------

まず Virtualbox マネージャーを立ち上げます。新しいグループにある Ubuntu-base が、先ほどインポートした Ubuntu-base.ova です。初めての VirtualBox であれば、Ubuntu-base だけ表示されているはずです。

新しいグループより Ubuntu-base → 設定（S）の順でクリックすると（ :numref:`settings1` 赤枠） Ubuntu-base の設定画面が現れます（ :numref:`settings2` ）。

.. figure:: ./images/settings1.png
      :scale: 100
      :name: settings1
      :align: center

      VM Ubuntu-base 管理画面を出す

.. figure:: ./images/settings2.png
      :scale: 100
      :name: settings2
      :align: center

      VM Ubuntu-base 管理画面

NAT
---

.. _refnat:

一つ目のネットワーク（アダプター 1）は NAT とします。この仮想イーサーネットアダプターよりノートパソコンの外へ通信を行います。
:numref:`settings2` より、ネットワーク → アダプター 1 の順でクリックし、アダプター 1 の設定を変更（ :numref:`nat` ）します。高度の左側 ▽ をクリックして全項目を展開してください:

.. figure:: ./images/nat.png
      :name: nat
      :align: center

      VM Ubuntu-base ネットワーク管理画面（NAT）

.. csv-table::
   :header: 項目, 設定値
   :widths: 10, 30

   ネットワーク, アダプター 1
   ネットワークアダプターを有効化, ✔
   割り当て, NAT
   アダプタータイプ, 準仮想化ネットワーク（virtio-net） [#]_
   ケーブル接続, ✔ [#]_

.. [#] 準仮想化ネットワークでなくてもいいのですが、若干負荷が軽くなるようです。ただし VM 側に準仮想化ネットワークドライバーがインストールされていなければなりません。
.. [#] **ケーブル接続を ✔ しないと、ネットワークケーブルが繋がっていない状態になり嵌ります** （イーサネットアダプターは VM より認識しますが通信できません）。

ホストオンリーアダプター
------------------------

.. _refhostonlyadapter:

ふたつ目のネットワーク（アダプター 2）はホストオンリーアダプタとします。この仮想イーサーネットアダプターより、ノートパソコン内で双方向通信が行うことができます。例えば、ssh で VM にログインするときは、アダプター 2 経由となります。

:numref:`settings2` より、ネットワーク → アダプター 2 の順でクリックし、アダプター 2 の設定を変更（ :numref:`hostonlyadapter` ）します。高度の左側 ▽ をクリックして全項目を展開してください:

.. figure:: ./images/hostonlyadapter.png
      :name: hostonlyadapter
      :align: center

      VM Ubuntu-base ネットワーク管理画面（ホストオンリーアダプター）

.. csv-table::
   :header: 項目, 設定値
   :widths: 10, 30

   ネットワーク, アダプター 2
   ネットワークアダプターを有効化, ✔
   名前, VirtualBox Host-Only Ethernet Adapter #3 [#]_
   割り当て, ホストオンリーアダプター
   アダプタータイプ, 準仮想化ネットワーク（virtio-net） [#]_
   ケーブル接続, ✔ [#]_

.. [#] ここで表示されている #3 については Host-Only Ethernet Adapter を過去何回作成したかによってかわります。
.. [#] 準仮想化ネットワークでなくてもいいのですが、若干負荷が軽くなるようです。ただし VM 側に準仮想化ネットワークドライバーがインストールされていなければなりません。
.. [#] **ケーブル接続を ✔ しないと、ネットワークケーブルが繋がっていない状態になり嵌ります** （イーサネットアダプターは VM より認識しますが通信できません）。

.. warning::
   VirtualBox Host-Only Ethernet Adapter #何某 が全くでないとき → :ref:`こちらで対処 <no-hostonlyadapter>`

VirtualBox Host-Only Ethernet Adapter #何某 がない
--------------------------------------------------

.. _no-hostonlyadapter:

残念ながら、はじめての VirtualBox でも VirtualBox Host-Only Ethernet Adapter が極稀に作られません。以下手動で作製します。

1. Virtualbox マネージャーを立ちあげツールをクリックします（ :numref:`tools` 赤枠）。

.. figure:: ./images/tools.png
   :name: tools
   :align: center

   ツール画面を出す

2. VirtualBox Host-Only Ethernet Adapter の設定画面になるので、作製をクリックします（ :numref:`tools-hostonlyadapter1` 赤枠）。このアプリがデバイスに変更を加えてもよろしいですかと確認画面が表示されるので、はいを選択します。

.. figure:: ./images/tools-hostonlyadapter1.png
   :name: tools-hostonlyadapter1
   :align: center

   VirtualBox Host-Only Ethernet Adapter の設定（まだ作成されていない）

3. なんらかの VirtualBox Host-Only Ethernet Adapter がひとつ表示されているはずです（ :numref:`tools-hostonlyadapter2` では #3）。設定のため VirtualBox Host-Only Ethernet Adapter #3 → プロパティとします（ :numref:`tools-hostonlyadapter2` 赤枠）。

.. figure:: ./images/tools-hostonlyadapter2.png
   :name: tools-hostonlyadapter2
   :align: center

   VirtualBox Host-Only Ethernet Adapter の設定（作成済）
           
4. VirtualBox Host-Only Ethernet Adapter をアダプタータブについて設定します（ :numref:`tools-hostonlyadapter3` 赤枠）。入力したら適用をクリックします。

.. figure:: ./images/tools-hostonlyadapter3.png
   :name: tools-hostonlyadapter3
   :align: center

   VirtualBox Host-Only Ethernet Adapter の設定（アダプター）

.. csv-table::
   :header: 項目, 設定値
   :widths: 10, 30

   名前, VirtualBox Host-Only Ethernet Adapter #3 [#]_
   アダプター || DHCP サーバー, アダプター
   アダプターを手動で設定, ●
   IPv4 アドレス, 192.168.56.1
   IPv4 ネットマスク, 255.255.255.0

.. [#] #3 の数値が違うと思いますが、出ているものを選んでください

5. VirtualBox Host-Only Ethernet Adapter を DHCP サーバーについて設定します（ :numref:`tools-hostonlyadapter4` 赤枠）。入力したら適用をクリックします。

.. figure:: ./images/tools-hostonlyadapter4.png
   :name: tools-hostonlyadapter4
   :align: center

   VirtualBox Host-Only Ethernet Adapter の設定（DHCP サーバー）

.. csv-table::
   :header: 項目, 設定値
   :widths: 10, 30

   名前, VirtualBox Host-Only Ethernet Adapter #3 [#]_
   アダプター || DHCP サーバー, DHCP サーバー
   サーバーを有効化, ✔
   サーバー アドレス, 192.168.56.2
   サーバー マスク, 255.255.255.0
   アドレス下限, 192.168.56.3
   アドレス上限, 192.168.56.254

.. [#] #3 の数値が違うと思いますが、出ているものを選んでください

6. |nbsp| :ref:`ホストオンリーアダプター <refhostonlyadapter>` に戻ってください。
