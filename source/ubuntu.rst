========================
 VM （Ubuntu） の動作確認
========================

設定した VirtualBox のネットワークの動作確認を行います。

起動
====

1. Virtualbox マネージャーを立ち上げ、新しいグループより Ubuntu-base → 起動 で Ubuntu VM を立ち上げます（ :numref:`run` 赤枠）。

.. figure:: ./images/run.png
   :name: run
   :align: center

   仮想 VM 起動

2. コンソールが立ち上がります。すでにお知らせしている Ubuntu VM 用 ID とパスワードでログインします。

シャットダウン
==============

``sudo poweroff`` です。シャットダウン処理後、コンソールは消えます。

.. code-block:: console

   cysec@cysec-pro:~$ sudo poweroff
   [sudo] cysec のパスワード: [1]

.. [#] 文字化けしていると思います。コンソールでは漢字が出ないのです。 

ネットワーク動作確認
====================

Ubuntu VM を再び立ち上げておきます。

* :ref:`インターフェース <refinterface>` 、 :ref:`NAT <refnat2>` については、Ubuntu にログインして確認します。
* :ref:`ホストオンリーアダプタ <refhostonlyadapter2>` については、Windows のコマンドラインプロンプトから確認します。 [2]_

.. [#] コマンドラインプロンプトの立ち上げ方を調べておきましょう。
  
インターフェース
----------------

.. _refinterface:

1 行目がコマンドラインです。同じように打ち込んで Ubuntu が認識しているネットワークインターフェースの表示を行います。 lo, enp0s3, enp0s8 が Ubuntu により認識されていなければなりません（2, 8, 14 行）。また inet を見れば（4, 10, 16 行）より、それぞれのネットワークインターフェースに IPv4 アドレスが割り当てられているはずです。

enp0s3, enp0s8 いずれかが存在しない、または、IPv4 アドレスが割り当てられていない場合は、VirtualBox の設定を見直しましょう。

.. code-block:: console
   :emphasize-lines: 1,2,4,8,10,14,16
   :linenos:

      cysec@cysec-pro:~$ ip address list
      1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
          link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
          inet 127.0.0.1/8 scope host lo
             valid_lft forever preferred_lft forever
          inet6 ::1/128 scope host
             valid_lft forever preferred_lft forever
      2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
          link/ether 08:00:27:9e:f2:5c brd ff:ff:ff:ff:ff:ff
          inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
             valid_lft 86306sec preferred_lft 86306sec
          inet6 fe80::a5ab:8465:8d0e:908f/64 scope link noprefixroute
             valid_lft forever preferred_lft forever
      3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
          link/ether 08:00:27:41:d4:71 brd ff:ff:ff:ff:ff:ff
          inet 192.168.56.4/24 brd 192.168.56.255 scope global dynamic noprefixroute enp0s8
             valid_lft 1107sec preferred_lft 1107sec
          inet6 fe80::9c55:7dd1:1bbd:681f/64 scope link noprefixroute
             valid_lft forever preferred_lft forever

* lo はローカルループバックインターフェース
* enp0s3 は :ref:`NAT <refnat>` （アダプタ 1）
* enp0s8 は :ref:`ホストオンリーアダプタ <refhostonlyadapter>` （アダプタ 2）

NAT
---

.. _refnat2:

VM から www.yahoo.co.jp へ ``ping`` をかけ、VM から Windows 外への通信を確認します（1 行）。終わらないので、 Ctrl + C （コントロールキーを押しながら C）で中断します。 www.yahoo.co.jp からの応答が返ってこなければ VirtualBox の設定を見直しましょう。

.. code-block:: console
   :emphasize-lines: 1
   :linenos:

   cysec@cysec-pro:~$ ping www.yahoo.co.jp
   PING edge12.g.yimg.jp (183.79.250.123) 56(84) bytes of data.
   64 bytes from 183.79.250.123 (183.79.250.123): icmp_seq=1 ttl=53 time=57.3 ms
   64 bytes from 183.79.250.123 (183.79.250.123): icmp_seq=2 ttl=53 time=54.1 ms
   64 bytes from 183.79.250.123 (183.79.250.123): icmp_seq=4 ttl=53 time=55.0 ms
   64 bytes from 183.79.250.123 (183.79.250.123): icmp_seq=5 ttl=53 time=53.8 ms
   64 bytes from 183.79.250.123 (183.79.250.123): icmp_seq=6 ttl=53 time=51.6 ms
   
   --- edge12.g.yimg.jp ping statistics ---
   6 packets transmitted, 5 received, 16% packet loss, time 5025ms
   rtt min/avg/max/mdev = 51.602/54.419/57.356/1.886 ms
   cysec@cysec-pro:~$

ホストオンリーアダプター
------------------------

.. _refhostonlyadapter2:

Windows のコマンドラインプロントで VM に ``ping`` をかけ、VM への通信を確認します（1 行）。 ``ping`` の対象（IPv4 アドレス）は :ref:`インターフェース <refinterface>` よりホストオンリーアダプタの inet にあります。VM からの応答が返ってこなければ VirtualBox の設定を見直しましょう。

.. code-block:: console
   :emphasize-lines: 1
   :linenos:

   C:\Users\yamachan>ping 192.168.56.4
   
   192.168.56.4 に ping を送信しています 32 バイトのデータ:
   192.168.56.4 からの応答: バイト数 =32 時間 <1ms TTL=64
   192.168.56.4 からの応答: バイト数 =32 時間 <1ms TTL=64
   192.168.56.4 からの応答: バイト数 =32 時間 <1ms TTL=64
   192.168.56.4 からの応答: バイト数 =32 時間 <1ms TTL=64
   
   192.168.56.4 の ping 統計:
       パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
   ラウンド トリップの概算時間 (ミリ秒):
       最小 = 0ms、最大 = 0ms、平均 = 0ms
   
   C:\Users\yamachan>exit

SSH 接続設定と動作確認
======================

Windows より ssh コマンドで VM にログインできるようにします。

VM 側の設定
-----------

VirtualBox コンソールより Ubuntu にログインし、ssh デーモンを起動します。 1,2,4,5,14,33,36 行目はコマンド、3 行目はパスワードを打ち込みます。
（ここには表示されていませんが） ``sudo apt install ssh`` の後に、同意を求められると思いますので Y と打ち込んでください。

.. code-block:: console
   :emphasize-lines: 1-5,14,33,36
   :linenos:

      cysec@cysec-pro:~$ export LANG=C
      cysec@cysec-pro:~$ sudo rm /var/lib/apt/lists/lock
      [sudo] password for cysec:
      cysec@cysec-pro:~$ sudo rm /var/cache/apt/archives/lock
      cysec@cysec-pro:~$ sudo apt update
      Hit:1 http://jp.archive.ubuntu.com/ubuntu bionic InRelease
      Hit:2 http://jp.archive.ubuntu.com/ubuntu bionic-updates InRelease
      Hit:3 http://jp.archive.ubuntu.com/ubuntu bionic-backports InRelease
      Hit:4 http://security.ubuntu.com/ubuntu bionic-security InRelease
      Reading package lists... Done
      Building dependency tree
      Reading state information... Done
      26 packages can be upgraded. Run 'apt list --upgradable' to see them.
      cysec@cysec-pro:~$ sudo apt install ssh
      Reading package lists... Done
      Building dependency tree
      Reading state information... Done
      The following package was automatically installed and is no longer required:
        libllvm7
      Use 'sudo apt autoremove' to remove it.
      The following NEW packages will be installed:
        ssh
      0 upgraded, 1 newly installed, 0 to remove and 26 not upgraded.
      Need to get 5204 B of archives.
      After this operation, 106 kB of additional disk space will be used.
      Get:1 http://jp.archive.ubuntu.com/ubuntu bionic-updates/main amd64 ssh all 1:7.6p1-4ubuntu0.3 [5204 B]
      Fetched 5204 B in 0s (10.8 kB/s)
      Selecting previously unselected package ssh.
      (Reading database ... 165504 files and directories currently installed.)
      Preparing to unpack .../ssh_1%3a7.6p1-4ubuntu0.3_all.deb ...
      Unpacking ssh (1:7.6p1-4ubuntu0.3) ...
      Setting up ssh (1:7.6p1-4ubuntu0.3) ...
      cysec@cysec-pro:~$ sudo systemctl enable ssh
      Synchronizing state of ssh.service with SysV service script with /lib/systemd/systemd-sysv-install.
      Executing: /lib/systemd/systemd-sysv-install enable ssh
      cysec@cysec-pro:~$ sudo service ssh start
      cysec@cysec-pro:~$

.. csv-table::
   :header: 行, 意味
   :widths: 3, 30

   1, 日本語を切ります
   "2,4", たまに apt update が上手く動かないときのための対処
   3, パスワードを入力してください
   5, パッケージリストの更新を行う
   14, ssh パッケージのインストール
   33, VM 起動時に ssh （サーバー）が自動的に開始するよう設定
   36, ssh （サーバー）サービスを開始

Windows 側の設定
----------------

Windows 10 バージョン 1803 以降では OpenSSH クライアントがデフォルトでインストールされていますが、もしされていない場合は、スタート → 設定 → アプリ → オプション機能の管理 → 機能の追加 から OpenSSH クライアント をインストールしてください。 :numref:`opensshclient` 赤枠のように OpenSSH クライアントと表示されていれば完了です。


.. figure:: ./images/opensshclient.png
   :name: opensshclient
   :align: center

   Windows 10 に OpenSSH クライアント がインストールされている

Windows から VM へログイン
--------------------------

コマンドプロンプトより、ホストオンリーアダプター（アダプタ 2）の IPv4 でログインします。4 行目は yes と答えてください。
VM に ssh でログイン後、脱出するコマンドは ``exit`` です。

.. code-block:: console
   :emphasize-lines: 1,4,6
   :linenos:

      C:\Users\yamachan>ssh cysec@192.168.56.5
      The authenticity of host '192.168.56.5 (192.168.56.5)' can't be established.
      ECDSA key fingerprint is SHA256:JLdgeW6OXTW2ZlNlbHMvPfUngYza/HDzARdMqQk5Djk.
      Are you sure you want to continue connecting (yes/no)? yes
      Warning: Permanently added '192.168.56.5' (ECDSA) to the list of known hosts.
      cysec@192.168.56.5's password:
      Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 5.0.0-23-generic x86_64)
      
       * Documentation:  https://help.ubuntu.com
       * Management:     https://landscape.canonical.com
       * Support:        https://ubuntu.com/advantage
         
         
       * Canonical Livepatch is available for installation.
         - Reduce system reboots and improve kernel security. Activate at:
           https://ubuntu.com/livepatch
           
      23 packages can be updated.
      0 updates are security updates.
      
      Your Hardware Enablement Stack (HWE) is supported until April 2023.
      Last login: Thu Aug  8 10:50:07 2019 from 192.168.56.1
      cysec@cysec-pro:~$
